<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
</head>

<body style="height: 100%; margin: 0">
    <div id="main" style="height: 100%"></div>
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
    <script src="./js/jquery-3.6.0.min.js"></script>

    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script> -->
    <script type="text/javascript" src="./js/echarts.min.js"></script>
    <!-- Uncomment this line if you want to dataTool extension
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/extension/dataTool.min.js"></script>
        -->
    <!-- Uncomment this line if you want to use gl extension -->
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script> -->
    <script type="text/javascript" src="./js/echarts-gl.min.js"></script>

    <!-- Uncomment this line if you want to echarts-stat extension
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-stat@latest/dist/ecStat.min.js"></script>
        -->
    <!-- Uncomment this line if you want to use map
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/map/js/china.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/map/js/world.js"></script>
        -->
    <!-- Uncomment these two lines if you want to use bmap extension
        <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=<Your Key Here>"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/extension/bmap.min.js"></script>
        -->

    <script type="text/javascript">

        // import * as echarts from 'echarts';
        // import 'echarts-gl';

        var ROOT_PATH = 'https://cdn.jsdelivr.net/gh/apache/echarts-website@asf-site/examples';

        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var option;

        // $.getJSON(ROOT_PATH + '/data-gl/asset/data/flights.json', function (data) {

        // setInterval(function () {
        //     $.getJSON('./flights.json', function (data) {
        //         handleData(data)
        //     });
        // }, 5000)

        $.getJSON('./result_v2.json', function (data) {
            handleData(data);
            // window.addEventListener('keydown', function () {
            //     series.forEach(function (series, idx) {
            //         myChart.dispatchAction({
            //             type: 'lines3DToggleEffect',
            //             seriesIndex: idx
            //         });
            //     })
            // });
        });

        // setTimeout(() => {
        //     $.getJSON('./flights2.json', function (data) {
        //         handleData(data)
        //     });
        // }, 5000);





        function handleData(data) {
            var airports = data.airports.map(function (item) {
                return {
                    name: item[0],
                    coord: [item[3], item[4]]
                }
            });
            console.log(data.airports)
            console.log(airports)
            function getAirportCoord(idx) {
                return [data.airports[idx][3], data.airports[idx][4]];
            }
            function getAirportName(idx) {
                return data.airports[idx][1];
            }

            // Route: [airlineIndex, sourceAirportIndex, destinationAirportIndex]
            var routesGroupByAirline = {};
            data.routes.forEach(function (route) {
                var airline = data.airlines[route[0]];
                var airlineName = airline[0];
                if (!routesGroupByAirline[airlineName]) {
                    routesGroupByAirline[airlineName] = [];
                }
                routesGroupByAirline[airlineName].push(route);
            });

            var pointsData = [];
            data.routes.forEach(function (route) {
                pointDataSrc = {
                    name: getAirportName(route[1]),
                    value: getAirportCoord(route[1])
                }
                pointDataDest = {
                    name: getAirportName(route[2]),
                    value: getAirportCoord(route[2])
                }
                pointsData.push(pointDataSrc);
                pointsData.push(pointDataDest);

                // pointsData.push(getAirportCoord(route[1]));
                // pointsData.push(getAirportCoord(route[2]));


            });

            var series = data.airlines.map(function (airline) {
                var airlineName = airline[0];
                var routes = routesGroupByAirline[airlineName];

                if (!routes) {
                    return null;
                }
                console.log(airlineName);
                return {
                    type: 'lines3D',
                    name: airlineName,

                    effect: {
                        show: true,
                        // period: 4,
                        // constantSpeed: 50, 
                        trailWidth: 2,
                        trailLength: 0.15,
                        trailOpacity: 1,
                        trailColor: 'rgb(40, 50, 80)'
                    },

                    lineStyle: {
                        width: 1,
                        color: 'rgb(50, 50, 150)',
                        // color: 'rgb(118, 233, 241)',
                        opacity: 0.1
                    },
                    blendMode: 'lighter',

                    data: routes.map(function (item) {
                        return [airports[item[1]].coord, airports[item[2]].coord];
                    })
                };
            }).filter(function (series) {
                return !!series;
            });


            // console.log('here is')
            // console.log(pointsData)
            series.push({
                type: 'scatter3D',
                coordinateSystem: 'globe',
                blendMode: 'lighter',
                symbol: 'circle',
                symbolSize: 1.5,
                itemStyle: {
                    color: 'rgb(100, 100, 101)',
                    opacity: 1
                },
                data: pointsData,
                label: {
                    // show: true,
                    formatter: '{b}',
                }
            });
            // console.log(pointsData)

            myChart.setOption({
                legend: {
                    selectedMode: 'single',
                    left: 'left',
                    data: Object.keys(routesGroupByAirline),
                    orient: 'vertical',
                    textStyle: {
                        color: '#fff'
                    }
                },
                globe: {

                    // environment: ROOT_PATH + '/data-gl/asset/starfield.jpg',
                    environment: './asset/8k_stars_milky_way.jpg',

                    // heightTexture: ROOT_PATH + '/data-gl/asset/bathymetry_bw_composite_4k.jpg',

                    // baseTexture: ROOT_PATH + '/data-gl/asset/earth.jpg',
                    // baseTexture: './asset/earth.jpg',


                    // baseTexture: './asset/world.topo.bathy.200401.jpg',
                    baseTexture: './asset/8k_earth_nightmap.jpg',


                    displacementScale: 0.5,
                    displacementQuality: 'ultra',

                    // baseColor: '#000',

                    shading: 'realistic',
                    // shading: 'lambert',
                    realisticMaterial: {
                        roughness: 0.3,
                        metalness: 0.1
                    },

                    // atmosphere: {
                    //     show: true,
                    // },

                    postEffect: {
                        enable: true,
                        depthOfField: {
                            enable: false,
                            focalDistance: 150
                        }
                    },
                    temporalSuperSampling: {
                        enable: true
                    },
                    light: {
                        ambient: {
                            intensity: 0.1
                        },
                        main: {
                            intensity: 0,
                            shadow: false
                        },
                        ambientCubemap: {
                            // texture: ROOT_PATH + '/data-gl/asset/lake.hdr',
                            texture: './asset/lake.hdr',
                            exposure: 1,
                            diffuseIntensity: 5,
                            specularIntensity: 1
                        }
                    },
                    viewControl: {
                        autoRotate: false
                    },
                    silent: true
                },
                series: series
            });



        }

        myChart.setOption(option);

    </script>
</body>

</html>